<!DOCTYPE html>
<html>
<head>
    <title>Scraper Monitor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        .stage { 
            padding: 10px; 
            margin: 5px; 
            border: 1px solid #ddd; 
            border-radius: 5px;
            transition: all 0.3s;
        }
        .stage.active { 
            background: #fff3cd; 
            border-color: #ffeeba;
        }
        .stage.completed { 
            background: #d4edda; 
            border-color: #c3e6cb;
        }
        .stage.error { 
            background: #f8d7da; 
            border-color: #f5c6cb;
        }
        .event-log {
            height: 200px;
            overflow-y: auto;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            margin-top: 15px;
        }
        .event-item {
            padding: 5px;
            margin: 5px 0;
            border-left: 3px solid #007bff;
        }
        .event-item.error {
            border-left-color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container my-4">
        <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
            <div class="container-fluid">
                <a class="navbar-brand" href="/">Website Monitor</a>
                <a class="btn btn-outline-primary" href="/">Back to Dashboard</a>
            </div>
        </nav>

        <!-- Add Last Run Status section after navbar -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Last Run Status</h5>
                <div id="lastRunStatus">
                    <p class="text-muted">Loading last run status...</p>
                </div>
            </div>
        </div>

        <h1>Scraper Monitor</h1>
        <div class="row mt-4">
            <!-- Scraper Form -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Start New Scrape</h5>
                        <form id="scraperForm" onsubmit="startScraper(event)">
                            <div class="mb-3">
                                <label for="pnr" class="form-label">PNR/Booking Code</label>
                                <input type="text" class="form-control" id="pnr" required>
                            </div>
                            <div class="mb-3">
                                <label for="gstin" class="form-label">GSTIN</label>
                                <input type="text" class="form-control" id="gstin" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Start Scraping</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Status Display -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Scraper Status</h5>
                        <div id="scrapperStatus">
                            <p class="text-muted">Waiting to start...</p>
                        </div>

                        <!-- Progress Stages -->
                        <div class="progress-stages mt-4">
                            <div class="stage" id="initialization-stage">
                                <h6>Initialization</h6>
                                <p id="initialization-status">Waiting...</p>
                                <small id="initialization-timing"></small>
                            </div>
                            <div class="stage" id="login-stage">
                                <h6>Login</h6>
                                <p id="login-status">Waiting...</p>
                                <small id="login-timing"></small>
                            </div>
                            <div class="stage" id="navigation-stage">
                                <h6>Navigation</h6>
                                <p id="navigation-status">Waiting...</p>
                                <small id="navigation-timing"></small>
                            </div>
                            <div class="stage" id="download-stage">
                                <h6>Download</h6>
                                <p id="download-status">Waiting...</p>
                                <small id="download-timing"></small>
                            </div>
                        </div>

                        <!-- Event Log -->
                        <div class="event-log mt-4">
                            <h6>Event Log</h6>
                            <div id="eventLog"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        
        // Add state management with default values
        let scraperState = {
            stages: {},
            eventLog: [],
            currentStage: null,
            timings: {},
            status: 'idle',
            lastRun: null
        };

        // Add error handling for state loading
        async function loadInitialState() {
            const statusDiv = document.getElementById('lastRunStatus');
            const scrapperStatus = document.getElementById('scrapperStatus');
            
            try {
                const lastStateResponse = await fetch('/scraper/last_state');
                const lastStateData = await lastStateResponse.json();
                
                if (lastStateData.success && lastStateData.data) {
                    // Update last run status
                    updateLastRunStatus(lastStateData.data);
                    
                    // Fill in the form with last used GSTIN and PNR
                    if (lastStateData.data.gstin) {
                        document.getElementById('gstin').value = lastStateData.data.gstin;
                    }
                    if (lastStateData.data.pnr) {
                        document.getElementById('pnr').value = lastStateData.data.pnr;
                    }
                }
                
                // Always show ready to start
                scrapperStatus.innerHTML = '<p class="text-muted">Ready to start</p>';
                
            } catch (error) {
                console.error('Error loading initial state:', error);
                statusDiv.innerHTML = '<p class="text-danger">Failed to load status</p>';
                scrapperStatus.innerHTML = '<p class="text-muted">Ready to start</p>';
            }
        }

        // Remove storeFrontendState function

        // Update socket connection handling
        socket.on('connect', () => {
            loadInitialState();  // Reload state when socket connects
            addEventLog({
                type: 'info',
                message: 'Connected to server'
            });
        });

        socket.on('disconnect', () => {
            addEventLog({
                type: 'error',
                message: 'Disconnected from server'
            });
        });

        socket.on('scraper_status', function(data) {
            console.log('Scraper status update:', data);
            updateStageProgress(data);
            
            // Update general status display
            const scrapperStatus = document.getElementById('scrapperStatus');
            scrapperStatus.innerHTML = `
                <p class="text-${data.status === 'error' ? 'danger' : 'info'}">
                    <strong>${data.stage.toUpperCase()}:</strong> ${data.message}
                </p>
            `;
            
            addEventLog({
                type: data.status === 'error' ? 'error' : 'info',
                message: `${data.stage.toUpperCase()}: ${data.message}`
            });
        });

        socket.on('scraper_error', function(data) {
            console.error('Scraper error:', data);
            addEventLog({
                type: 'error',
                message: data.error || 'Unknown error occurred'
            });
        });

        socket.on('scraper_general_status', function(data) {
            const scrapperStatus = document.getElementById('scrapperStatus');
            const statusClass = data.status === 'error' ? 'text-danger' : 
                              data.status === 'success' ? 'text-success' : 'text-info';
            
            scrapperStatus.innerHTML = `
                <p class="${statusClass}">
                    ${data.message}
                    <small class="text-muted d-block">${data.timestamp}</small>
                </p>
            `;
        });

        // Load last state on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadInitialState();  // Load initial state
            
            // Add connection status check
            if (!socket.connected) {
                setTimeout(() => {
                    if (!socket.connected) {
                        const statusDiv = document.getElementById('lastRunStatus');
                        statusDiv.innerHTML = '<p class="text-warning">Connecting to server...</p>';
                    }
                }, 3000);
            }
        });

        function updateLastRunStatus(state) {
            const statusDiv = document.getElementById('lastRunStatus');
            if (!state || !state.last_run) {
                statusDiv.innerHTML = '<p class="text-muted">No previous runs</p>';
                return;
            }

            try {
                const lastRunTime = new Date(state.last_run).toLocaleString();
                const nextRunTime = state.next_run ? new Date(state.next_run).toLocaleString() : 'Not scheduled';
                const statusClass = state.state === 'success' ? 'text-success' : 
                                  state.state === 'failed' ? 'text-danger' : 'text-warning';

                statusDiv.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Last Run:</strong> ${lastRunTime}</p>
                            <p><strong>Status:</strong> <span class="${statusClass}">${state.state || 'Unknown'}</span></p>
                            <p><strong>PNR:</strong> ${state.pnr || 'N/A'}</p>
                            <p><strong>GSTIN:</strong> ${state.gstin || 'N/A'}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Next Run:</strong> ${nextRunTime}</p>
                            <p><strong>Auto Run:</strong> ${state.auto_run ? 'Enabled' : 'Disabled'}</p>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error updating last run status:', error);
                statusDiv.innerHTML = '<p class="text-danger">Error displaying status</p>';
            }
        }

        // Update startScraper function to store state
        async function startScraper(event) {
            event.preventDefault();
            
            // Reset status display
            const scrapperStatus = document.getElementById('scrapperStatus');
            scrapperStatus.innerHTML = '<p class="text-info">Starting scraper...</p>';
            
            // Reset stages
            document.querySelectorAll('.stage').forEach(stage => {
                stage.classList.remove('active', 'completed', 'error');
                const statusElement = stage.querySelector('p');
                if (statusElement) statusElement.textContent = 'Waiting...';
                const timingElement = stage.querySelector('small');
                if (timingElement) timingElement.textContent = '';
            });
            
            // Clear event log
            document.getElementById('eventLog').innerHTML = '';
            
            // Reset state
            scraperState.stages = {};
            scraperState.eventLog = [];
            scraperState.currentStage = null;
            scraperState.timings = {};
            scraperState.status = 'running';
            
            // Get form data
            const pnr = document.getElementById('pnr').value;
            const gstin = document.getElementById('gstin').value;
            
            // Show loading state
            const submitButton = event.target.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Starting...';
            
            // Make API call with frontend state
            const formData = new FormData();
            formData.append('pnr', pnr);
            formData.append('gstin', gstin);
            formData.append('frontend_state', JSON.stringify(scraperState));
            
            try {
                const response = await fetch('/run_starair_scraper', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.message || 'Failed to start scraper');
                }
                
                addEventLog({
                    type: 'info',
                    message: 'Scraper started successfully'
                });

                // Save final state
                scraperState.status = 'completed';
                scraperState.lastRun = new Date().toISOString();
                
                // Update last run status
                const stateResponse = await fetch('/scraper/last_state');
                const stateData = await stateResponse.json();
                if (stateData.success) {
                    updateLastRunStatus(stateData.data);
                }
            } catch (error) {
                scraperState.status = 'error';
                addEventLog({
                    type: 'error',
                    message: error.message
                });
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = 'Start Scraping';
            }
        }

        function updateStageProgress(data) {
            const stageElement = document.getElementById(`${data.stage}-stage`);
            const statusElement = document.getElementById(`${data.stage}-status`);
            const timingElement = document.getElementById(`${data.stage}-timing`);
            
            if (stageElement && statusElement) {
                stageElement.classList.remove('active', 'completed', 'error');
                stageElement.classList.add(data.status === 'error' ? 'error' : 
                                         data.status === 'completed' ? 'completed' : 'active');
                
                statusElement.textContent = data.message;
                
                if (data.timing) {
                    timingElement.textContent = `Time: ${data.timing}s`;
                }

                // Update state
                scraperState.stages[data.stage] = {
                    status: data.status,
                    message: data.message,
                    timing: data.timing,
                    timestamp: data.timestamp
                };
                scraperState.currentStage = data.stage;
            }
        }

        function addEventLog(event) {
            const container = document.getElementById('eventLog');
            const item = document.createElement('div');
            item.className = `event-item ${event.type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            item.innerHTML = `
                <small class="text-muted">${timestamp}</small>
                <div class="event-message">${event.message}</div>
            `;
            
            container.appendChild(item);
            container.scrollTop = container.scrollHeight;

            // Update state
            scraperState.eventLog.push({
                type: event.type,
                message: event.message,
                timestamp: timestamp
            });
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
